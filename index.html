<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoEHT Control Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 24px;
            text-align: center;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.running {
            background: #10b981;
        }

        .status-dot.stopped {
            background: #ef4444;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-stop {
            background: #ef4444;
            color: white;
        }

        .btn-stop:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }

        .btn-start {
            background: #10b981;
            color: white;
        }

        .btn-start:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .btn-refresh {
            background: #3b82f6;
            color: white;
        }

        .btn-refresh:hover {
            background: #2563eb;
        }

        .input-group {
            margin-bottom: 12px;
        }

        label {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
            color: #555;
        }

        input, select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .file-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            transition: background 0.2s;
        }

        .file-item:hover {
            background: #f9fafb;
        }

        .file-name {
            font-weight: 500;
            color: #333;
        }

        .file-size {
            color: #6b7280;
            font-size: 12px;
        }

        .file-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-view {
            background: #8b5cf6;
            color: white;
        }

        .btn-delete {
            background: #ef4444;
            color: white;
        }

        .log-viewer {
            background: #1f2937;
            color: #10b981;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .alert {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéÆ AutoEHT Control Panel</h1>

        <!-- Status Bar -->
        <div class="card">
            <div class="status-bar">
                <div class="status-indicator">
                    <span class="status-dot stopped" id="statusDot"></span>
                    <span id="statusText">ƒêang ki·ªÉm tra...</span>
                </div>
                <button class="btn-refresh" onclick="checkStatus()">üîÑ L√†m m·ªõi</button>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="card">
            <h2 style="margin-bottom: 16px;">ƒêi·ªÅu khi·ªÉn Auto</h2>
            <div id="alertContainer"></div>
            
            <div class="input-group">
                <label>IP Address / Hostname</label>
                <input type="text" id="serverIp" value="localhost" placeholder="localhost">
            </div>

            <div class="input-group">
                <label>Port</label>
                <input type="number" id="serverPort" value="8080" placeholder="8080">
            </div>

            <div class="input-group">
                <label>Lo·∫°i Auto</label>
                <select id="autoType">
                    <option value="Trang b·ªã">Trang b·ªã</option>
                    <option value="C∆∞·ªùng h√≥a">C∆∞·ªùng h√≥a</option>
                    <option value="T·∫©y thu·ªôc t√≠nh">T·∫©y thu·ªôc t√≠nh</option>
                    <option value="Th√∫ c∆∞·ª°i">Th√∫ c∆∞·ª°i</option>
                    <option value="R∆∞∆°ng boss">R∆∞∆°ng boss</option>
                    <option value="T√≠nh c√°ch">T√≠nh c√°ch</option>
                    <option value="R∆∞∆°ng trang b·ªã th√∫">R∆∞∆°ng trang b·ªã th√∫</option>
                    <option value="ƒêai l∆∞ng">ƒêai l∆∞ng</option>
                    <option value="ƒêai l∆∞ng MAX">ƒêai l∆∞ng MAX</option>
                    <option value="H·∫ßm ng·ª•c">H·∫ßm ng·ª•c</option>
                </select>
            </div>

            <div class="input-group">
                <label>Scenario (t√πy ch·ªçn)</label>
                <input type="text" id="scenario" placeholder="V√≠ d·ª•: Gi√°p, GƒÉng, Gi√†y...">
            </div>

            <div class="control-panel">
                <button class="btn-start" onclick="startAuto()">‚ñ∂Ô∏è Kh·ªüi ƒë·ªông</button>
                <button class="btn-stop" onclick="stopAuto()">‚èπÔ∏è D·ª´ng Auto</button>
            </div>
        </div>

        <!-- File Manager -->
        <div class="card">
            <h2 style="margin-bottom: 16px;">Qu·∫£n l√Ω File</h2>
            <button class="btn-refresh" onclick="loadFiles()" style="margin-bottom: 16px;">
                üîÑ T·∫£i danh s√°ch file
            </button>
            <div class="file-list" id="fileList">
                <p style="color: #6b7280; text-align: center; padding: 20px;">
                    Nh·∫•n "T·∫£i danh s√°ch file" ƒë·ªÉ xem
                </p>
            </div>
        </div>

        <!-- Log Viewer -->
        <div class="card">
            <h2 style="margin-bottom: 16px;">Xem Log</h2>
            <div class="log-viewer" id="logViewer">
                Ch·ªçn file ƒë·ªÉ xem n·ªôi dung...
            </div>
        </div>
    </div>

    <script>
		function getBaseUrl() {
			const ip = document.getElementById('serverIp').value.trim() || 'localhost';
			const port = document.getElementById('serverPort').value || '8080';
			return `http://${ip}:${port}`;
		}

		function showAlert(message, type = 'success') {
			const container = document.getElementById('alertContainer');
			container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
			setTimeout(() => container.innerHTML = '', 6000);
		}

		async function checkStatus() {
			try {
				const res = await fetch(`${getBaseUrl()}/status`);
				const data = await res.json();
				const dot = document.getElementById('statusDot');
				const text = document.getElementById('statusText');
				if (data.running) {
					dot.className = 'status-dot running';
					text.textContent = 'Auto ƒëang ch·∫°y';
				} else {
					dot.className = 'status-dot stopped';
					text.textContent = 'Auto ƒë√£ d·ª´ng';
				}
			} catch (err) {
				document.getElementById('statusText').textContent = 'Kh√¥ng th·ªÉ k·∫øt n·ªëi server';
				showAlert('L·ªói k·∫øt n·ªëi: ' + err.message, 'error');
			}
		}

		async function stopAuto() {
			try {
				const res = await fetch(`${getBaseUrl()}/stop`, { method: 'POST' });
				const data = await res.json();
				showAlert(data.message || (data.success ? 'ƒê√£ d·ª´ng Auto' : 'L·ªói khi d·ª´ng'), data.success ? 'success' : 'error');
				checkStatus();
			} catch (err) {
				showAlert('L·ªói: ' + err.message, 'error');
			}
		}

		async function startAuto() {
			const type = document.getElementById('autoType').value;
			const scenario = document.getElementById('scenario').value.trim();
			const searchB = document.getElementById('searchB').checked;

			const url = new URL(`${getBaseUrl()}/start/${encodeURIComponent(type)}`);
			if (scenario) url.searchParams.append('scenario', scenario);
			if (searchB) url.searchParams.append('searchB', 'true');

			try {
				const res = await fetch(url, { method: 'POST' });
				const data = await res.json();
				let msg = data.message || 'Kh·ªüi ƒë·ªông th√†nh c√¥ng';
				if (scenario) msg += ` (scenario: ${scenario})`;
				if (searchB) msg += ' - t√¨m trong kho';
				showAlert(msg, 'success');
				checkStatus();
			} catch (err) {
				showAlert('L·ªói kh·ªüi ƒë·ªông: ' + err.message, 'error');
			}
		}

		function formatSize(bytes) {
			return (bytes / 1024).toFixed(2) + ' KB';
		}

		function formatDate(timestampMs) {
			const d = new Date(timestampMs);
			return d.toLocaleDateString('vi-VN') + ' ' + d.toLocaleTimeString('vi-VN');
		}

		async function loadFiles() {
			const fileList = document.getElementById('fileList');
			fileList.innerHTML = '<p style="text-align: center; padding: 20px;"><span class="loading"></span> ƒêang t·∫£i...</p>';

			try {
				const res = await fetch(`${getBaseUrl()}/files`);
				const data = await res.json();

				if (!data.success || data.files.length === 0) {
					fileList.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 40px;">Kh√¥ng c√≥ file n√†o</p>';
					return;
				}

				fileList.innerHTML = '';
				data.files.forEach(file => {
					const div = document.createElement('div');
					div.className = 'file-item';
					div.innerHTML = `
						<div class="file-info">
							<div class="file-name">üìÑ ${file.name}</div>
							<div class="file-meta">${formatSize(file.size)} ‚Ä¢ ${formatDate(file.modified)}</div>
						</div>
						<div class="file-actions">
							<button class="btn-small btn-view" onclick="viewFile('${file.name.replace(/'/g, "\\'")}')">üëÅÔ∏è Xem</button>
							<button class="btn-small btn-delete" onclick="deleteFile('${file.name.replace(/'/g, "\\'")}')">üóëÔ∏è X√≥a</button>
						</div>
					`;
					fileList.appendChild(div);
				});
			} catch (err) {
				fileList.innerHTML = `<p style="text-align: center; color: #ef4444; padding: 20px;">L·ªói t·∫£i danh s√°ch: ${err.message}</p>`;
			}
		}

		// ƒê√É S·ª¨A: ƒê·ªïi t·ª´ /log/ th√†nh /logs/ ƒë·ªÉ kh·ªõp v·ªõi server
		async function viewFile(filename) {
			const viewer = document.getElementById('logViewer');
			viewer.textContent = '‚è≥ ƒêang t·∫£i n·ªôi dung file...';

			try {
				const res = await fetch(`${getBaseUrl()}/logs/${encodeURIComponent(filename)}`);
				const data = await res.json();
				viewer.textContent = data.success ? (data.content || '(File tr·ªëng)') : 'L·ªói: ' + data.error;
			} catch (err) {
				viewer.textContent = 'L·ªói t·∫£i file: ' + err.message;
			}
		}

		async function deleteFile(filename) {
			if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a file "${filename}"?`)) return;

			try {
				const res = await fetch(`${getBaseUrl()}/files/${encodeURIComponent(filename)}`, { method: 'DELETE' });
				const data = await res.json();
				showAlert(data.message || (data.success ? 'ƒê√£ x√≥a file' : 'L·ªói x√≥a file'), data.success ? 'success' : 'error');
				loadFiles();
			} catch (err) {
				showAlert('L·ªói x√≥a: ' + err.message, 'error');
			}
		}

		// T·ª± ƒë·ªông ki·ªÉm tra tr·∫°ng th√°i m·ªói 5 gi√¢y
		setInterval(checkStatus, 5000);
		checkStatus();
	</script>
</body>
</html>